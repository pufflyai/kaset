<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Tiny UI Runtime</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: transparent;
      }
      #root {
        height: 100%;
      }
    </style>
    <script type="module">
      import { guest } from "https://esm.sh/rimless@0.6.0";

      const IMPORT_MAP_ID = "tiny-importmap";
      const STYLE_FLAG = "data-tiny-style";

      const el = (sel) => document.querySelector(sel);
      const container = (sel) => el(sel) ?? el("#root") ?? document.body;

      function ensureImportMap(importMap) {
        if (!importMap) return;
        let s = document.getElementById(IMPORT_MAP_ID);
        if (!s) {
          s = document.createElement("script");
          s.id = IMPORT_MAP_ID;
          s.type = "importmap";
          document.head.appendChild(s);
        }
        s.textContent = JSON.stringify(importMap, null, 2);
      }

      function ensureStyles(styles) {
        if (!Array.isArray(styles) || styles.length === 0) return;
        for (const href of styles) {
          if (!href) continue;
          const q = `link[rel="stylesheet"][${STYLE_FLAG}="${href}"]`;
          if (document.head.querySelector(q)) continue;
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = href;
          link.setAttribute(STYLE_FLAG, href);
          document.head.appendChild(link);
        }
      }

      /** Runtime API exposed to the host */
      const runtimeApi = {
        /**
         * Boot the runtime and mount the entry export.
         * The host promises to provide: { id, moduleUrl, importMap?, styles?, entryExport?, mountSelector?, runtimeOptions?, meta? }
         */
        async init(init, remote) {
          try {
            console.log("[tiny-ui-runtime] init", init, remote);

            ensureImportMap(init.importMap);
            ensureStyles(init.styles);

            if (typeof init.moduleUrl !== "string" || !init.moduleUrl) {
              throw new Error("Missing or invalid moduleUrl");
            }

            const mod = await import(init.moduleUrl);
            const exportName = init.entryExport ?? "mount";
            const entry = typeof mod[exportName] === "function" ? mod[exportName] : mod.default;

            console.log("[tiny-ui-runtime] imported module", mod, "using export", exportName, entry);

            if (typeof entry !== "function") {
              throw new Error(`Entry export '${exportName}' is not a function`);
            }

            const mountEl = container(init.mountSelector ?? "#root");

            if (!remote || typeof remote.ops !== "function") {
              throw new Error("Tiny UI host does not expose remote.ops");
            }

            const invoke = (method, params) => {
              if (typeof method !== "string" || !method.trim()) {
                throw new Error("Tiny UI host call requires a method string");
              }
              return remote.ops({ method, params });
            };

            const toParams = (args) => {
              if (!args || args.length === 0) return {};
              if (args.length === 1) {
                const single = args[0];
                if (single && typeof single === "object") return single;
                return { value: single };
              }
              const [first, second, ...rest] = args;
              if (typeof first === "string" && second && typeof second === "object") {
                return { path: first, ...second, rest };
              }
              return { args };
            };

            const createNamespaceProxy = (prefix) =>
              new Proxy(
                {},
                {
                  get(_target, prop) {
                    if (typeof prop !== "string") return undefined;
                    return (...args) => invoke(prefix ? `${prefix}.${prop}` : prop, toParams(args));
                  },
                },
              );

            const host = {
              fs: {
                readFile(path) {
                  return invoke("fs.readFile", { path });
                },
                writeFile(path, data) {
                  return invoke("fs.writeFile", { path, data });
                },
               ls(dir = "") {
                  return invoke("fs.ls", { dir });
                },
                dirSnapshot(dir = "") {
                  return remote.ops({ method: "fs.dirSnapshot", params: { dir } });
                },
                deleteFile(path) {
                  return invoke("fs.deleteFile", { path });
                },
                downloadFile(path, filename) {
                  return invoke("fs.downloadFile", { path, filename });
                },
                exists(path) {
                  return remote.ops({ method: "fs.exists", params: { path } });
                },
                mkdirp(path) {
                  return remote.ops({ method: "fs.mkdirp", params: { path } });
                },
                moveFile(from, to) {
                  return remote.ops({ method: "fs.moveFile", params: { from, to } });
                },
                readJSON(path) {
                  return remote.ops({ method: "fs.readJSON", params: { path } });
                },
                writeJSON(path, value, pretty = false) {
                  return remote.ops({ method: "fs.writeJSON", params: { path, value, pretty } });
                },
              },
              workspace: {
                read(path) {
                  return invoke("workspace.read", { path });
                },
                readFile(path) {
                  return invoke("workspace.readFile", { path });
                },
              },
              settings: {
                read() {
                  return invoke("settings.read", {});
                },
                write(value) {
                  return invoke("settings.write", { value });
                },
              },
              commands: {
                notify(level, message) {
                  return invoke("commands.notify", { level, message });
                },
              },
              call(method, params) {
                return invoke(method, params);
              },
            };

            host.actions = createNamespaceProxy("actions");

            console.log("[tiny-ui-runtime] mounting entry", host);

            await entry(mountEl, host, init.runtimeOptions ?? {});
            await remote.ready({ id: init.id, meta: init.meta });
          } catch (err) {
            const e = err instanceof Error ? err : new Error("Failed to initialize module");
            await remote.runtimeError({ id: init?.id, message: e.message, stack: e.stack });
          }
        },
      };

      await guest.connect(runtimeApi);
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
